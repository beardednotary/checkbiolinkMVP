<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CheckBioLink</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --black: #0a0a0a;
            --gray-900: #121212;
            --gray-800: #1a1a1a;
            --gray-700: #2a2a2a;
            --gray-600: #3a3a3a;
            --gray-400: #888888;
            --gray-200: #d4d4d4;
            --white: #ffffff;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: var(--black);
            color: var(--white);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Auth page --- */
        .auth-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        .auth-card {
            width: 100%;
            max-width: 400px;
        }
        .auth-card h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: .25rem;
        }
        .auth-card .subtitle {
            color: var(--gray-400);
            font-size: .95rem;
            margin-bottom: 2rem;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--gray-700);
            margin-bottom: 1.5rem;
        }
        .tab {
            flex: 1;
            padding: .75rem 0;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--gray-400);
            font-size: .95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
        }
        .tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }
        label {
            display: block;
            font-size: .875rem;
            font-weight: 500;
            color: var(--gray-200);
            margin-bottom: .375rem;
        }
        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: .625rem .75rem;
            border: 1px solid var(--gray-700);
            border-radius: 6px;
            font-size: .95rem;
            color: var(--white);
            background: var(--gray-900);
            transition: border-color .2s;
        }
        input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .field { margin-bottom: 1rem; }

        /* --- Buttons --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: .6rem 1.25rem;
            border-radius: 6px;
            font-size: .875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all .2s;
            text-decoration: none;
        }
        .btn-primary {
            background: var(--accent);
            color: var(--white);
        }
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: transparent;
            color: var(--white);
            border: 1px solid var(--gray-600);
        }
        .btn-secondary:hover { border-color: var(--gray-400); }
        .btn-danger {
            background: transparent;
            color: var(--red);
            border: 1px solid var(--gray-700);
        }
        .btn-danger:hover {
            border-color: var(--red);
            background: rgba(239,68,68,.1);
        }
        .btn-sm { padding: .375rem .75rem; font-size: .8125rem; }
        .btn-full { width: 100%; }

        /* --- Alerts --- */
        .alert {
            padding: .75rem 1rem;
            border-radius: 6px;
            font-size: .875rem;
            margin-bottom: 1rem;
            display: none;
        }
        .alert.show { display: block; }
        .alert-error {
            background: rgba(239,68,68,.1);
            border: 1px solid rgba(239,68,68,.25);
            color: var(--red);
        }

        /* --- Dashboard shell --- */
        .dashboard { display: none; }
        .dashboard.active { display: block; }

        .topbar {
            padding: 0 2rem;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray-800);
            position: sticky;
            top: 0;
            background: rgba(10, 10, 10, 0.8);
            backdrop-filter: blur(10px);
            z-index: 50;
        }
        .topbar-brand {
            font-size: 1.125rem;
            font-weight: 700;
        }
        .topbar-right {
            display: flex;
            align-items: center;
            gap: .75rem;
        }
        .topbar-email {
            font-size: .875rem;
            color: var(--gray-400);
        }
        .topbar-plan {
            font-size: .75rem;
            font-weight: 600;
            padding: .2rem .6rem;
            border-radius: 4px;
            background: rgba(59,130,246,.15);
            color: var(--accent);
            text-transform: capitalize;
        }

        .main {
            max-width: 960px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* --- Trial / expired banners --- */
        .trial-banner {
            display: none;
            align-items: center;
            justify-content: space-between;
            background: rgba(234,179,8,.08);
            border: 1px solid rgba(234,179,8,.2);
            border-radius: 6px;
            padding: .75rem 1rem;
            margin-bottom: 1.5rem;
            font-size: .875rem;
            color: var(--gray-200);
        }
        .trial-banner.show { display: flex; }
        .trial-banner strong { color: var(--yellow); }

        .expired-banner {
            display: none;
            background: rgba(239,68,68,.08);
            border: 1px solid rgba(239,68,68,.2);
            border-radius: 6px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-size: .875rem;
            color: var(--gray-200);
        }
        .expired-banner.show { display: block; }
        .expired-banner strong { color: var(--red); }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }
        .page-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
        }
        .link-count {
            font-size: .875rem;
            color: var(--gray-400);
            font-weight: 400;
        }

        /* --- Link cards --- */
        .links-list {
            display: flex;
            flex-direction: column;
            gap: .75rem;
        }
        .link-card {
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: border-color .2s;
        }
        .link-card:hover { border-color: var(--gray-600); }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .status-dot.up { background: var(--green); }
        .status-dot.down { background: var(--red); }
        .status-dot.unknown { background: var(--gray-600); }

        .link-info { flex: 1; min-width: 0; }
        .link-name {
            font-weight: 600;
            font-size: .95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-url {
            font-size: .8125rem;
            color: var(--gray-400);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link-meta {
            text-align: right;
            flex-shrink: 0;
        }
        .link-status-label {
            font-size: .8125rem;
            font-weight: 600;
        }
        .link-status-label.up { color: var(--green); }
        .link-status-label.down { color: var(--red); }
        .link-status-label.unknown { color: var(--gray-400); }
        .link-checked {
            font-size: .75rem;
            color: var(--gray-400);
        }
        .link-actions {
            display: flex;
            gap: .375rem;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-400);
        }
        .empty-state h3 {
            font-size: 1.1rem;
            color: var(--gray-200);
            margin-bottom: .5rem;
        }
        .empty-state p { margin-bottom: 1.5rem; }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-400);
        }

        /* --- Modals --- */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--gray-800);
            border: 1px solid var(--gray-700);
            border-radius: 12px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-700);
        }
        .modal-head h3 { font-size: 1.1rem; font-weight: 700; }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            color: var(--gray-400);
            cursor: pointer;
            padding: .25rem;
        }
        .modal-close:hover { color: var(--white); }
        .modal-body { padding: 1.5rem; }

        /* --- Pricing modal --- */
        .modal-pricing { max-width: 780px; }
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .plan-card {
            background: var(--gray-900);
            border: 1px solid var(--gray-700);
            border-radius: 12px;
            padding: 1.5rem 1.25rem;
            text-align: center;
            transition: all .3s;
        }
        .plan-card:hover {
            border-color: var(--gray-600);
            transform: translateY(-4px);
        }
        .plan-card.featured {
            border-color: var(--accent);
            position: relative;
        }
        .plan-card.featured::before {
            content: 'POPULAR';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent);
            color: var(--white);
            padding: .3rem 1rem;
            border-radius: 20px;
            font-size: .75rem;
            font-weight: 600;
            letter-spacing: .05em;
        }
        .plan-name {
            font-size: .875rem;
            font-weight: 600;
            color: var(--gray-400);
            text-transform: uppercase;
            letter-spacing: .05em;
            margin-bottom: .5rem;
        }
        .plan-price {
            font-size: 2.5rem;
            font-weight: 800;
            margin: .5rem 0;
        }
        .plan-price span { font-size: .875rem; font-weight: 400; color: var(--gray-400); }
        .plan-trial {
            color: var(--gray-400);
            font-size: .9rem;
            margin-bottom: 1rem;
        }
        .plan-features {
            list-style: none;
            text-align: left;
            margin: 1.25rem 0;
            font-size: .875rem;
            color: var(--gray-200);
        }
        .plan-features li { padding: .4rem 0; }
        .plan-features li::before {
            content: "\2713";
            color: var(--accent);
            font-weight: 700;
            margin-right: .7rem;
        }
        .plan-cta {
            display: block;
            width: 100%;
            text-align: center;
        }

        /* --- History modal --- */
        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: .8125rem;
        }
        .history-table th {
            text-align: left;
            padding: .5rem .75rem;
            border-bottom: 2px solid var(--gray-700);
            color: var(--gray-400);
            font-weight: 600;
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .05em;
        }
        .history-table td {
            padding: .5rem .75rem;
            border-bottom: 1px solid var(--gray-700);
            color: var(--gray-200);
        }
        .history-up { color: var(--green); font-weight: 600; }
        .history-down { color: var(--red); font-weight: 600; }

        @media (max-width: 768px) {
            .page-header { flex-direction: column; gap: .75rem; align-items: flex-start; }
            .link-card { flex-wrap: wrap; }
            .link-meta { display: none; }
            .plans-grid { grid-template-columns: 1fr; }
            .topbar-email { display: none; }
            .trial-banner { flex-direction: column; gap: .5rem; align-items: flex-start; }
        }
    </style>
</head>
<body>

<!-- ========== AUTH ========== -->
<div id="authPage" class="auth-page">
    <div class="auth-card">
        <h1>CheckBioLink</h1>
        <p class="subtitle">Monitor your links around the clock.</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('login')">Sign in</button>
            <button class="tab" onclick="switchTab('register')">Create account</button>
        </div>

        <div class="alert alert-error" id="authError"></div>

        <form id="loginForm" onsubmit="handleLogin(event)">
            <div class="field">
                <label for="loginEmail">Email</label>
                <input type="email" id="loginEmail" required placeholder="you@example.com">
            </div>
            <div class="field">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required placeholder="Your password">
            </div>
            <button type="submit" class="btn btn-primary btn-full">Sign in</button>
        </form>

        <form id="registerForm" onsubmit="handleRegister(event)" style="display:none">
            <div class="field">
                <label for="registerEmail">Email</label>
                <input type="email" id="registerEmail" required placeholder="you@example.com">
            </div>
            <div class="field">
                <label for="registerPassword">Password</label>
                <input type="password" id="registerPassword" required placeholder="Min. 8 characters" minlength="8">
            </div>
            <button type="submit" class="btn btn-primary btn-full">Create account</button>
        </form>
    </div>
</div>

<!-- ========== DASHBOARD ========== -->
<div id="dashboardPage" class="dashboard">
    <div class="topbar">
        <div class="topbar-brand">CheckBioLink</div>
        <div class="topbar-right">
            <span class="topbar-plan" id="planBadge"></span>
            <span class="topbar-email" id="userEmail"></span>
            <button class="btn btn-secondary btn-sm" onclick="showPricing()">Plans</button>
            <button class="btn btn-secondary btn-sm" onclick="handleLogout()">Sign out</button>
        </div>
    </div>

    <div class="main">
        <div class="trial-banner" id="trialBanner">
            <span>You have <strong id="trialDays"></strong> days left in your free trial.</span>
            <button class="btn btn-sm btn-primary" onclick="showPricing()">Choose a plan</button>
        </div>

        <div class="expired-banner" id="expiredBanner">
            <strong>Your trial has ended.</strong>
            <p style="margin-top:.5rem">Subscribe to keep monitoring your links.</p>
            <button class="btn btn-primary btn-sm" onclick="showPricing()" style="margin-top:.75rem">View plans</button>
        </div>

        <div class="page-header">
            <h2>Links <span class="link-count" id="linkCount"></span></h2>
            <button class="btn btn-primary btn-sm" id="addLinkBtn" onclick="openAddModal()">+ Add link</button>
        </div>

        <div id="linksContainer">
            <div class="loading-state">Loading...</div>
        </div>
    </div>
</div>

<!-- ========== ADD LINK MODAL ========== -->
<div id="addLinkOverlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">
            <h3>Add a link</h3>
            <button class="modal-close" onclick="closeAddModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form onsubmit="handleAddLink(event)">
                <div class="field">
                    <label for="linkName">Name</label>
                    <input type="text" id="linkName" required placeholder="My Website">
                </div>
                <div class="field">
                    <label for="linkUrl">URL</label>
                    <input type="url" id="linkUrl" required placeholder="https://example.com">
                </div>
                <button type="submit" class="btn btn-primary btn-full">Add link</button>
            </form>
        </div>
    </div>
</div>

<!-- ========== HISTORY MODAL ========== -->
<div id="historyOverlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-head">
            <h3 id="historyTitle">Check history</h3>
            <button class="modal-close" onclick="closeHistory()">&times;</button>
        </div>
        <div class="modal-body" id="historyBody">
            <p class="loading-state">Loading...</p>
        </div>
    </div>
</div>

<!-- ========== PRICING MODAL ========== -->
<div id="pricingOverlay" class="modal-overlay">
    <div class="modal modal-pricing">
        <div class="modal-head">
            <h3>Choose your plan</h3>
            <button class="modal-close" onclick="closePricing()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="color:var(--gray-400);font-size:.875rem;margin-bottom:1.25rem;text-align:center">All plans include a 14-day free trial. Cancel anytime.</p>
            <div class="plans-grid">
                <div class="plan-card">
                    <div class="plan-name">Starter</div>
                    <div class="plan-price">$7<span>/mo</span></div>
                    <div class="plan-trial">14-day free trial</div>
                    <ul class="plan-features">
                        <li>3 links monitored</li>
                        <li>Check every 4 hours</li>
                        <li>Email alerts</li>
                        <li>30-day history</li>
                    </ul>
                    <a href="https://buy.stripe.com/dRmaEYbaB6Cxextdh8gfu00" class="btn btn-secondary plan-cta">Start Trial</a>
                </div>
                <div class="plan-card featured">
                    <div class="plan-name">Pro</div>
                    <div class="plan-price">$15<span>/mo</span></div>
                    <div class="plan-trial">14-day free trial</div>
                    <ul class="plan-features">
                        <li>10 links monitored</li>
                        <li>Check every 2 hours</li>
                        <li>Email alerts</li>
                        <li>90-day history</li>
                    </ul>
                    <a href="https://buy.stripe.com/14A5kE6Ul9OJahdgtkgfu01" class="btn btn-primary plan-cta">Start Trial</a>
                </div>
                <div class="plan-card">
                    <div class="plan-name">Agency</div>
                    <div class="plan-price">$29<span>/mo</span></div>
                    <div class="plan-trial">14-day free trial</div>
                    <ul class="plan-features">
                        <li>50 links monitored</li>
                        <li>Check every hour</li>
                        <li>Email alerts</li>
                        <li>1-year history</li>
                    </ul>
                    <a href="https://buy.stripe.com/4gM00k5Qh7GB4WTfpggfu02" class="btn btn-secondary plan-cta">Start Trial</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentUser = null;

function switchTab(tab) {
    document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
    document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
    document.querySelectorAll('.tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
    });
    hideError();
}

function showError(msg) {
    const el = document.getElementById('authError');
    el.textContent = msg;
    el.classList.add('show');
}
function hideError() {
    document.getElementById('authError').classList.remove('show');
}

async function handleLogin(e) {
    e.preventDefault();
    hideError();
    try {
        const res = await fetch('/api/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: document.getElementById('loginEmail').value,
                password: document.getElementById('loginPassword').value
            })
        });
        const data = await res.json();
        if (res.ok) { await enterDashboard(); }
        else { showError(data.error || 'Login failed'); }
    } catch { showError('Network error. Please try again.'); }
}

async function handleRegister(e) {
    e.preventDefault();
    hideError();
    try {
        const res = await fetch('/api/register', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                email: document.getElementById('registerEmail').value,
                password: document.getElementById('registerPassword').value
            })
        });
        const data = await res.json();
        if (res.ok) { await enterDashboard(); }
        else { showError(data.error || 'Registration failed'); }
    } catch { showError('Network error. Please try again.'); }
}

function handleLogout() {
    fetch('/api/logout', {method: 'POST', headers: {'Content-Type': 'application/json'}})
        .then(() => {
            currentUser = null;
            document.getElementById('authPage').style.display = 'flex';
            document.getElementById('dashboardPage').classList.remove('active');
        });
}

async function enterDashboard() {
    try {
        const res = await fetch('/api/user/status');
        if (!res.ok) return;
        currentUser = await res.json();
    } catch { return; }

    document.getElementById('authPage').style.display = 'none';
    document.getElementById('dashboardPage').classList.add('active');
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('planBadge').textContent = currentUser.plan;

    const trialBanner = document.getElementById('trialBanner');
    const expiredBanner = document.getElementById('expiredBanner');
    trialBanner.classList.remove('show');
    expiredBanner.classList.remove('show');

    if (currentUser.subscription_status === 'trial') {
        if (currentUser.is_trial_active) {
            document.getElementById('trialDays').textContent = currentUser.days_left_in_trial;
            trialBanner.classList.add('show');
        } else {
            expiredBanner.classList.add('show');
        }
    } else if (currentUser.subscription_status === 'canceled') {
        expiredBanner.querySelector('strong').textContent = 'Your subscription has been canceled.';
        expiredBanner.classList.add('show');
    }

    loadLinks();
}

async function loadLinks() {
    const container = document.getElementById('linksContainer');
    container.innerHTML = '<div class="loading-state">Loading...</div>';

    try {
        const res = await fetch('/api/links');
        const data = await res.json();

        if (res.status === 403 && data.trial_expired) {
            container.innerHTML = '';
            return;
        }

        const links = data.links || [];
        document.getElementById('linkCount').textContent = currentUser
            ? `(${links.length} / ${currentUser.links_limit})`
            : '';

        if (links.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No links yet</h3>
                    <p>Add your first link to start monitoring.</p>
                    <button class="btn btn-primary btn-sm" onclick="openAddModal()">+ Add link</button>
                </div>`;
            return;
        }

        container.innerHTML = '<div class="links-list"></div>';
        const list = container.querySelector('.links-list');
        links.forEach(link => list.appendChild(createLinkCard(link)));
    } catch {
        container.innerHTML = '<p style="text-align:center;color:var(--red)">Error loading links.</p>';
    }
}

function createLinkCard(link) {
    const card = document.createElement('div');
    card.className = 'link-card';

    const status = link.status || 'unknown';
    const statusLabel = status === 'up' ? 'Online' : status === 'down' ? 'Offline' : 'Pending';
    const checked = link.last_checked
        ? timeAgo(new Date(link.last_checked))
        : 'Never';

    card.innerHTML = `
        <div class="status-dot ${status}"></div>
        <div class="link-info">
            <div class="link-name">${esc(link.name || 'Unnamed')}</div>
            <div class="link-url">${esc(link.url)}</div>
            <div class="link-checked">Last checked ${checked}</div>
        </div>
        <div class="link-meta">
            <div class="link-status-label ${status}">${statusLabel}</div>
        </div>
        <div class="link-actions">
            <button class="btn btn-secondary btn-sm" onclick="viewHistory(${link.id}, '${esc(link.name || link.url)}')">History</button>
            <button class="btn btn-secondary btn-sm" onclick="checkLink(${link.id}, this)">Check Now</button>
            <button class="btn btn-danger btn-sm" onclick="deleteLink(${link.id})">Delete</button>
        </div>`;
    return card;
}

// CHANGES MADE:
// 1. "Last checked" now shows directly under the URL in the link-info section
// 2. Changed "Up/Down" to "Online/Offline" (more user-friendly)
// 3. Changed "Check" button to "Check Now" (clearer action)
// 4. Moved "last checked" from the right meta column to under the URL for better visibility

function openAddModal() { document.getElementById('addLinkOverlay').classList.add('active'); }
function closeAddModal() {
    document.getElementById('addLinkOverlay').classList.remove('active');
    document.getElementById('linkName').value = '';
    document.getElementById('linkUrl').value = '';
}

async function handleAddLink(e) {
    e.preventDefault();
    try {
        const res = await fetch('/api/links', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                name: document.getElementById('linkName').value,
                url: document.getElementById('linkUrl').value
            })
        });
        if (res.ok) {
            closeAddModal();
            const statusRes = await fetch('/api/user/status');
            if (statusRes.ok) currentUser = await statusRes.json();
            loadLinks();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to add link');
        }
    } catch { alert('Network error'); }
}

async function checkLink(id, btn) {
    if (btn) { btn.textContent = '...'; btn.disabled = true; }
    try {
        await fetch(`/api/links/${id}/check`, {method: 'POST', headers: {'Content-Type': 'application/json'}});
        loadLinks();
    } catch { alert('Error checking link'); }
}

async function deleteLink(id) {
    if (!confirm('Delete this link?')) return;
    try {
        await fetch(`/api/links/${id}`, {method: 'DELETE', headers: {'Content-Type': 'application/json'}});
        const statusRes = await fetch('/api/user/status');
        if (statusRes.ok) currentUser = await statusRes.json();
        loadLinks();
    } catch { alert('Error deleting link'); }
}

async function viewHistory(id, name) {
    document.getElementById('historyTitle').textContent = `History: ${name}`;
    document.getElementById('historyBody').innerHTML = '<p class="loading-state">Loading...</p>';
    document.getElementById('historyOverlay').classList.add('active');

    try {
        const res = await fetch(`/api/links/${id}/history`);
        const data = await res.json();
        const checks = data.history || [];

        if (checks.length === 0) {
            document.getElementById('historyBody').innerHTML = '<p style="color:var(--gray-400);text-align:center">No check history yet.</p>';
            return;
        }

        let rows = checks.map(c => {
            const time = new Date(c.checked_at).toLocaleString();
            const cls = c.is_up ? 'history-up' : 'history-down';
            const label = c.is_up ? 'Up' : 'Down';
            const code = c.status_code || '-';
            const rt = c.response_time ? c.response_time.toFixed(2) + 's' : '-';
            return `<tr>
                <td>${time}</td>
                <td class="${cls}">${label}</td>
                <td>${code}</td>
                <td>${rt}</td>
            </tr>`;
        }).join('');

        document.getElementById('historyBody').innerHTML = `
            <table class="history-table">
                <thead><tr><th>Time</th><th>Status</th><th>Code</th><th>Response</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>`;
    } catch {
        document.getElementById('historyBody').innerHTML = '<p style="color:var(--red)">Error loading history.</p>';
    }
}
function closeHistory() { document.getElementById('historyOverlay').classList.remove('active'); }

function showPricing() { document.getElementById('pricingOverlay').classList.add('active'); }
function closePricing() { document.getElementById('pricingOverlay').classList.remove('active'); }

function esc(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function timeAgo(date) {
    const s = Math.floor((Date.now() - date.getTime()) / 1000);
    if (s < 60) return 'just now';
    if (s < 3600) return Math.floor(s / 60) + 'm ago';
    if (s < 86400) return Math.floor(s / 3600) + 'h ago';
    return Math.floor(s / 86400) + 'd ago';
}

document.querySelectorAll('.modal-overlay').forEach(el => {
    el.addEventListener('click', e => { if (e.target === el) el.classList.remove('active'); });
});

window.addEventListener('load', () => enterDashboard());
</script>
</body>
</html>
